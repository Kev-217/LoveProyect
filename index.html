<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Imperfectamente Feliz - Para Dana</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />

    <style>
        /* =========================================
           1. VARIABLES Y CONFIGURACI칍N MAESTRA
           ========================================= */
        :root {
            /* Colores del tema */
            --bg-color: #050510;
            --text-gold: #FFD700;
            --accent-blue: #00FFFF;
            --accent-purple: #9D00FF;

            /* --- TIPOGRAF칈A FLUIDA (La magia de la v3.0) --- */
            /* clamp(m칤nimo, ideal, m치ximo) 
               Esto hace que el texto cambie suavemente de tama침o seg칰n la pantalla */
            --font-size-base: clamp(1rem, 2vw, 1.25rem);
            --font-size-title: clamp(1.5rem, 5vw, 2.5rem);
            --spacing-stanza: clamp(20px, 5vh, 40px);
            /* Espacio entre estrofas */
        }

        body {
            margin: 0;
            background-color: var(--bg-color);
            color: #fff;
            font-family: 'Georgia', serif;
            /* Fuente elegante */
            overflow-x: hidden;
            /* Evita scroll horizontal accidental */
            font-size: var(--font-size-base);
        }

        /* =========================================
           2. PANTALLA DE CARGA (Tipo Hacker/Terminal)
           ========================================= */
        #terminal-loader {
            position: fixed;
            /* Fijo encima de todo */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 9999;
            /* La capa m치s alta */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-family: 'Courier New', monospace;
            /* Letra de c칩digo */
            color: #0f0;
            /* Verde matrix */
            padding: 20px;
        }

        /* Contenedor del texto que se escribe solo */
        .typing-effect {
            font-size: clamp(1rem, 3vw, 1.5rem);
            margin-bottom: 20px;
            text-align: left;
            width: 100%;
            max-width: 500px;
            min-height: 100px;
            /* Reserva espacio para que no "brinque" al escribir */
        }

        /* Barra de carga real */
        #loading-bar-container {
            width: 80%;
            max-width: 400px;
            height: 4px;
            background: #333;
            /* Fondo oscuro de la barra */
            margin-bottom: 20px;
            display: none;
            /* Se oculta hasta que JS lo activa */
        }

        #loading-bar {
            height: 100%;
            width: 0%;
            /* Empieza vac칤a */
            background: var(--accent-blue);
            transition: width 0.2s;
            /* Animaci칩n suave al llenarse */
            box-shadow: 0 0 10px var(--accent-blue);
            /* Brillo ne칩n */
        }

        /* Bot칩n de inicio */
        #enter-btn {
            padding: 15px 30px;
            background: transparent;
            border: 2px solid var(--accent-blue);
            color: var(--accent-blue);
            font-family: 'Courier New', monospace;
            font-size: 1rem;
            cursor: pointer;
            opacity: 0;
            /* Invisible al inicio */
            pointer-events: none;
            /* No se puede clicar hasta que cargue */
            transition: all 0.5s;
            box-shadow: 0 0 10px var(--accent-blue);
        }

        /* Clase para activar el bot칩n cuando todo est치 listo */
        #enter-btn.active {
            opacity: 1;
            pointer-events: all;
        }

        #enter-btn:hover {
            background: var(--accent-blue);
            color: #000;
        }

        /* =========================================
           3. CANVAS DE FONDO (Mariposas)
           ========================================= */
        #bg-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            /* Detr치s del texto */
            /* El gradiente base del fondo */
            background: radial-gradient(circle at bottom, #1a0b2e 0%, #050510 70%);
            transition: background 3s ease;
            /* Cambio de color suave al hacer scroll */
        }

        /* =========================================
           4. ESTILOS DEL POEMA (Glassmorphism)
           ========================================= */
        .poem-container {
            max-width: 700px;
            margin: 0 auto;
            /* Centrado horizontal */
            padding: 100px 20px;
            text-align: center;
            position: relative;
            z-index: 10;
        }

        .stanza {
            margin-bottom: 60px;
            padding: var(--spacing-stanza);
            border-radius: 20px;
            /* Efecto cristal esmerilado */
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            /* Para Safari/iPhone */
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);

            /* Estado inicial para animaci칩n (invisible y m치s abajo) */
            opacity: 0;
            transform: translateY(50px) scale(0.9);
            transition: all 0.8s cubic-bezier(0.25, 1, 0.5, 1);
        }

        /* Cuando JS detecta que es visible, le a침ade esta clase */
        .stanza.visible {
            opacity: 1;
            transform: translateY(0) scale(1);
            background: rgba(255, 255, 255, 0.07);
            border-color: rgba(255, 215, 0, 0.3);
        }

        .gold-text {
            color: var(--text-gold);
            font-weight: bold;
        }

        .blue-text {
            color: var(--accent-blue);
            text-shadow: 0 0 5px var(--accent-blue);
        }

        /* =========================================
           5. CARRUSEL (SWIPER)
           ========================================= */
        .swiper {
            width: 90%;
            max-width: 500px;
            aspect-ratio: 3 / 4;
            /* Proporci칩n vertical */
            margin: 80px auto;
            border-radius: 20px;
            box-shadow: 0 0 30px rgba(157, 0, 255, 0.4);
            opacity: 0;
            transition: opacity 2s;
        }

        .swiper.visible {
            opacity: 1;
        }

        .swiper-slide img,
        .swiper-slide video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 15px;
            background-color: #000;
        }

        /* =========================================
           6. VOTOS FINALES Y CANDADO
           ========================================= */
        .final-vow {
            font-size: clamp(1.2rem, 3vw, 1.5rem);
            color: var(--text-gold);
            border: 1px solid var(--text-gold);
            padding: 40px;
            margin-top: 100px;
            background: rgba(0, 0, 0, 0.5);
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.2);
            border-radius: 10px;
            font-style: italic;
        }

        /* Luna de fondo */
        .moon-bg {
            position: fixed;
            top: 10%;
            right: -10%;
            /* Tama침o responsivo de la luna */
            width: clamp(200px, 40vw, 400px);
            height: clamp(200px, 40vw, 400px);
            background: radial-gradient(circle, #ffffe0 10%, rgba(255, 255, 224, 0) 70%);
            border-radius: 50%;
            opacity: 0.15;
            z-index: -1;
            filter: blur(20px);
            pointer-events: none;
        }

        /* Caja del Candado */
        #lock-screen {
            text-align: center;
            padding: 50px;
            border: 1px solid var(--accent-blue);
            background: rgba(0, 0, 0, 0.8);
            border-radius: 20px;
            margin-top: 50px;
            position: relative;
            overflow: hidden;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }

        /* Bot칩n de Huella/Coraz칩n */
        #fingerprint-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 2px solid var(--text-gold);
            background: transparent;
            color: var(--text-gold);
            font-size: 2rem;
            cursor: pointer;
            position: relative;
            z-index: 2;
            animation: pulse-btn 2s infinite;
            /* Latido */
        }

        @keyframes pulse-btn {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.4);
            }

            70% {
                box-shadow: 0 0 0 20px rgba(255, 215, 0, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(255, 215, 0, 0);
            }
        }

        /* Relleno amarillo al mantener presionado */
        .fill-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 0%;
            /* JS cambiar치 esto */
            background: linear-gradient(to top, #FFD700, #ffaa00);
            z-index: 0;
            opacity: 0.3;
        }

        /* Estados de borrosidad del texto final */
        .final-vow.locked {
            filter: blur(20px);
            pointer-events: none;
            user-select: none;
            transition: filter 2s ease;
        }

        .final-vow.unlocked {
            filter: blur(0px);
        }

        /* Part칤culas (brillitos al tocar) */
        .sparkle {
            position: absolute;
            width: 6px;
            height: 6px;
            background: var(--text-gold);
            border-radius: 50%;
            pointer-events: none;
            box-shadow: 0 0 10px var(--text-gold);
            animation: sparkle-anim 1s linear forwards;
            z-index: 999;
        }

        @keyframes sparkle-anim {
            100% {
                transform: scale(3);
                opacity: 0;
            }
        }
    </style>
</head>

<body>

    <div id="terminal-loader">
        <div class="typing-effect" id="console-text"></div>
        <div id="loading-bar-container">
            <div id="loading-bar"></div>
        </div>
        <p id="loading-percent" style="font-size: 0.8rem; margin-bottom: 20px; color: #555;">0%</p>
        <button id="enter-btn">[ EJECUTAR PROTOCOLO KINTSUGI ]</button>
    </div>

    <canvas id="bg-canvas"></canvas>

    <svg class="kintsugi-crack" viewBox="0 0 100 100" preserveAspectRatio="none">
        <path d="M50,-10 Q45,20 55,30 T45,60 T55,90 T50,110" fill="none" stroke="url(#gold-gradient)"
            stroke-width="0.5" />
        <defs>
            <linearGradient id="gold-gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" style="stop-color:#bf953f;stop-opacity:0" />
                <stop offset="50%" style="stop-color:#fcf6ba;stop-opacity:1" />
                <stop offset="100%" style="stop-color:#b38728;stop-opacity:0" />
            </linearGradient>
        </defs>
    </svg>
    <style>
        .kintsugi-crack {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            opacity: 0.6;
            pointer-events: none;
            filter: drop-shadow(0 0 5px gold);
        }

        .kintsugi-crack path {
            stroke-dasharray: 200;
            stroke-dashoffset: 200;
            animation: drawCrack 10s ease-out forwards 2s;
        }

        @keyframes drawCrack {
            to {
                stroke-dashoffset: 0;
            }
        }
    </style>

    <div class="moon-bg" id="moon"></div>

    <div class="poem-container">
        <div class="stanza">Yo fui el viajero ciego que solt칩 tu mano,<br>buscando un falso fuego en mapas
            extranjeros;<br>cre칤 que el para칤so era un <span class="gold-text">lugar lejano</span>,<br>y perd칤 la ruta
            por mirar a otros cielos.</div>
        <div class="stanza">Camin칠 persiguiendo un oasis inventado,<br>una espiga dorada que solo fue
            reflejo;<br>idealizando sombras, sin haberlas tocado,<br>mientras t칰 te romp칤as a solas frente al espejo.
        </div>
        <div class="stanza">Te dej칠 all칤 dormida, mi peque침a <span class="gold-text">albondiguita</span>,<br>huyendo de
            un silencio que no supe llenar;<br>Busqu칠 en la falsa magia lo que el <span class="gold-text">ego</span>
            necesita,<br>sin ver que era tu calma mi forma de respirar.</div>
        <div class="stanza">Pero el <span class="gold-text">karma</span>, maestro de lecciones tan crudas,<br>me oblig칩
            a ver de lejos tu nueva libertad;<br>te vi brillar entre tantos, ajena a mis dudas,<br>con la fuerza
            imponente de tu propia verdad.</div>
        <div class="stanza">Mis celos fueron lava, mi mente una herida,<br>imaginando manos rozando lo que
            am칠;<br>escotes que luc칤as, segura y decidida,<br>mientras yo en mi vac칤o, borracho te llor칠.</div>
        <div class="stanza">En mis noches de fr칤o buscaba a mi <span class="gold-text">sirena</span>,<br>ese <span
                class="gold-text">dulce tarareo</span> que al sue침o me llevaba;<br>quer칤a ser tu <span
                class="gold-text">borreguito</span>, purgar mi condena,<br>volver a ese refugio que en tu piel me
            guardaba.</div>
        <div class="stanza">Pero el hambre nos gan칩, rompimos la distancia,<br>la carne fue la goma para el
            desconsuelo;<br>tu cuerpo hab칤a cambiado, not칠 la discrepancia,<br>tus curvas dibujaban un nuevo desvelo.
        </div>
        <div class="stanza">Volvimos a la cama sin t칤tulos ni jueces,<br>viviendo en esa casa nuestra propia
            anarqu칤a;<br>haci칠ndolo con labia, dos o tres mil veces,<br>llenando con gemidos la estancia vac칤a.</div>
        <div class="stanza">Ah칤 encontr칠 mi paz, en el <span class="gold-text">fruto sagrado</span>,<br>ese dulce
            remedio para mi ansiedad;<br>el sabor que cur칩 mis d칤as cansados,<br>sentirme en casa, a salvo, en plena
            oscuridad.</div>
        <div class="stanza">Jugamos al caos, <span class="gold-text">huevos revueltos</span>,<br>gritos de placer fueron
            mi absoluci칩n;<br>con mis dedos sedientos, r치pidos y sueltos,<br>te di lo que callabas en cada rinc칩n.</div>
        <div class="stanza">En menos de un mes descubrimos, piel contra piel,<br>lo que un a침o de novios no supo
            ense침ar;<br>que el sexo no es tan solo un acto de placer,<br>sino un lenguaje nuevo para <span
                class="gold-text">reaprender a amar</span>.</div>
        <div class="stanza">Y ah칤 cambi칩 el sistema, se reescribi칩 el c칩digo,<br>ya no eras la ni침a que hu칤a a
            dormir;<br>te vi mujer inmensa, rompiendo el protocolo,<br>ense침치ndome a quedarme, a luchar y a sentir.
        </div>
        <div class="stanza">Volvimos rotos, con las manos abiertas,<br>t칰 con tu pelo nuevo, yo con mi vieja
            culpa;<br>cruzamos el umbral de las puertas inciertas,<br>pidiendo al universo una segunda disculpa.</div>
        <div class="stanza">No fue borr칩n ni cuenta nueva,<br>fue aceptar la historia, mirarnos las <span
                class="gold-text">heridas</span>;<br>t칰 callaste mi error para salvar mi emblema,<br>y ante tus padres
            fuiste mi escudo, mi vida.</div>
        <div class="stanza">Esa noche en <span class="gold-text">Wings</span>, con una <span class="gold-text">rosa
                improvisada</span>,<br>envuelta en aluminio, imperfecta y real;<br>te ped칤 que volvieras, mi ni침a, mi
            amada,<br>a escribir con mi pluma un nuevo final.</div>

        <div class="stanza" id="music-trigger">
            Hoy s칠 que no eres musa, eres algo m치s grande,<br>eres los cuatro elementos de mi propia estaci칩n;<br>eres
            <span class="blue-text">Fuego</span> que calienta cuando el fr칤o se expande,<br>la <span
                class="gold-text">pasi칩n</span> que con unos mangos me da relajaci칩n.
        </div>
        <div class="stanza">Eres <span class="blue-text">Agua</span> que limpia con llanto cristalino,<br>record치ndome
            lo <span class="gold-text">fr치giles</span> que somos al amar;<br>eres <span class="blue-text">Viento</span>
            que <span class="gold-text">empuja</span> mi barco en el camino,<br>cuando el estr칠s del mundo me quiere
            sofocar.</div>
        <div class="stanza">Pero sobre todo eres <span class="blue-text">Tierra</span>, mi suelo firme,<br>donde
            plantamos <span class="gold-text">frutos</span> de esfuerzo y de valor;<br>donde saco dieces sin llegar a
            destruirme,<br>porque tu paz me ayuda a ser un triunfador.</div>
        <div class="stanza">S칤, el "clic" fue un destello, una manzana dulce,<br>un veneno que un d칤a me atrev칤 a
            probar;<br>pero t칰 eres la vida que hace que me impulse,<br>la <span class="gold-text">compa침era
                eterna</span> con quien quiero luchar.</div>
        <div class="stanza">Quiz치s no somos perfectos, ni cuentos de hadas,<br>quiz치s a veces falte la chispa o la
            fluidez;<br>pero hay coraje en nuestras manos entrelazadas,<br>y ganas de quedarnos hasta la vejez.</div>
        <div class="stanza">Entend칤 a la mala, perdiendo el camino,<br>que amar no es colonizar, es ceder y
            crecer;<br>que t칰 eres mi certeza, mi hogar, mi destino,<br>y que la entrega, mi vida... siempre vence al
            placer.</div>
        <div class="stanza">No quiero m치s musas viviendo en mi mente,<br>te quiero a ti, Dana, con tu luz y tu
            gris;<br>aqu칤 estoy en mi barco, contigo al frente,<br>siendo, por fin, <span
                class="gold-text">imperfectamente feliz</span>.</div>

        <div class="swiper mySwiper" id="gallery-trigger">
            <div class="swiper-wrapper">
                <div class="swiper-slide"><img src="1.jpeg" loading="lazy"></div>
                <div class="swiper-slide"><video src="2v.mp4" muted loop playsinline class="slide-video"></video></div>
                <div class="swiper-slide"><video src="3v.mp4" muted loop playsinline class="slide-video"></video></div>
                <div class="swiper-slide"><img src="4.jpeg" loading="lazy"></div>
                <div class="swiper-slide"><img src="5.jpeg" loading="lazy"></div>
                <div class="swiper-slide"><img src="6.jpeg" loading="lazy"></div>
                <div class="swiper-slide"><video src="7v.mp4" muted loop playsinline class="slide-video"></video></div>
                <div class="swiper-slide"><img src="8.jpeg" loading="lazy"></div>
                <div class="swiper-slide"><video src="9v.mp4" muted loop playsinline class="slide-video"></video></div>
                <div class="swiper-slide"><img src="10.jpeg" loading="lazy"></div>
                <div class="swiper-slide"><video src="11v.mp4" muted loop playsinline class="slide-video"></video></div>
                <div class="swiper-slide"><video src="12v.mp4" muted loop playsinline class="slide-video"></video></div>
                <div class="swiper-slide"><video src="13v.mp4" muted loop playsinline class="slide-video"></video></div>
                <div class="swiper-slide"><video src="14v.mp4" muted loop playsinline class="slide-video"></video></div>
                <div class="swiper-slide"><img src="15.jpeg" loading="lazy"></div>
                <div class="swiper-slide"><video src="16v.mp4" muted loop playsinline class="slide-video"></video></div>
                <div class="swiper-slide"><video src="17v.mp4" muted loop playsinline class="slide-video"></video></div>
            </div>
            <div class="swiper-pagination"></div>
        </div>

        <div id="lock-screen">
            <div class="fill-overlay" id="fill-bar"></div>
            <p style="font-family: 'Courier New'; color: var(--accent-blue); margin-bottom: 20px;">
                丘멆잺 ARCHIVO ENCRIPTADO <br>
                <span style="font-size: 0.8rem">Mant칠n presionado para reparar el v칤nculo</span>
            </p>
            <button id="fingerprint-btn">仇벒잺</button>
        </div>

        <div class="stanza final-vow locked" id="final-vow-box">
            Con esta mano sostendr칠 tus anhelos,<br>
            tu copa nunca estar치 vac칤a;<br>
            quiero ser tu vino, <br>
            tu luz en los cielos,<br><br>
            y con este anillo...<br>
            <span
                style="display: block; font-size: clamp(2rem, 5vw, 3.5rem); text-shadow: 0 0 20px gold; margin-top: 20px;">TE
                PIDO QUE SEAS M칈A</span>
        </div>

        <br><br><br><br>
        <p style="font-size: 0.8rem; color: #555;">Compilado con amor v3.0 (Optimized)</p>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

    <script>
        // ==========================================
        // SECCI칍N 1: PRELOADER REAL (Gesti칩n de Recursos)
        // ==========================================

        // 丘멆잺 IMPORTANTE: Aseg칰rate de que estos nombres son EXACTOS a tus archivos.
        // Si hay una may칰scula/min칰scula diferente, la carga se quedar치 pegada.
        const assetsToLoad = [
            'mamichula.mp3',
            'piano.mp3'
            // Opcional: Si quieres pre-cargar la primera foto para que salga instant치nea, agr칠gala aqu칤:
            // '1.jpeg' 
        ];

        // Variables donde guardaremos la m칰sica cargada en memoria
        let audioBuffers = {};
        // Variables del sistema de audio profesional (Web Audio API)
        let audioCtx, gainNode1, gainNode2, source1, source2, analyser;

        // Referencias a los elementos visuales de carga
        const loadingBar = document.getElementById('loading-bar');
        const loadingPercent = document.getElementById('loading-percent');
        const enterBtn = document.getElementById('enter-btn');
        const barContainer = document.getElementById('loading-bar-container');

        // Funci칩n as칤ncrona: Carga los archivos uno por uno
        async function loadAssets() {
            barContainer.style.display = "block"; // Muestra la barra
            let loadedCount = 0;

            // Iniciamos el texto de "hacker" visual mientras carga lo real
            typeWriter();

            // Creamos una lista de tareas de descarga (Promesas)
            const promises = assetsToLoad.map(async (url) => {
                try {
                    // Pide el archivo al servidor
                    const response = await fetch(url);
                    // Lo convierte en datos puros (ArrayBuffer)
                    const arrayBuffer = await response.arrayBuffer();
                    audioBuffers[url] = arrayBuffer; // Lo guarda en memoria

                    // Actualiza la barra de progreso
                    loadedCount++;
                    const percent = Math.floor((loadedCount / assetsToLoad.length) * 100);
                    loadingBar.style.width = percent + "%";
                    loadingPercent.innerText = "Cargando audio: " + percent + "%";
                } catch (e) {
                    console.error("Error cargando recurso:", url);
                    loadingPercent.innerText = "Error en archivo: " + url;
                }
            });

            // Espera a que TODO se descargue antes de continuar
            await Promise.all(promises);

            // Todo listo: Habilita el bot칩n para entrar
            loadingPercent.innerText = "Recursos listos. Esperando usuario.";
            enterBtn.classList.add('active');
        }

        // ==========================================
        // SECCI칍N 2: SISTEMA DE AUDIO (Web Audio API)
        // ==========================================
        // Esto reemplaza a las etiquetas <audio> b치sicas para evitar cortes.

        function initAudioSystem() {
            // Crea el "Contexto de Audio" (el motor de sonido del navegador)
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();

            // Crea "Nodos de Ganancia" (como las perillas de volumen de una mesa de DJ)
            gainNode1 = audioCtx.createGain();
            gainNode2 = audioCtx.createGain();
            analyser = audioCtx.createAnalyser(); // Para analizar graves (efecto luna)

            // Configurar vol칰menes iniciales
            gainNode1.gain.value = 1; // Pista 1 (Mamichula) al 100%
            gainNode2.gain.value = 0; // Pista 2 (Piano) silenciada

            // Decodifica y reproduce Audio 1
            playBuffer(assetsToLoad[0], gainNode1, true); // true = loop infinito
            // Prepara Audio 2 pero empieza en silencio
            playBuffer(assetsToLoad[1], gainNode2, true);

            // Conexiones: Fuente -> Volumen -> Analizador -> Bocinas
            gainNode1.connect(analyser);
            gainNode2.connect(analyser);
            analyser.connect(audioCtx.destination);

            visualizeAudio(); // Inicia la animaci칩n de la luna
        }

        // Funci칩n auxiliar para decodificar y tocar un audio desde memoria
        async function playBuffer(url, gainNode, loop) {
            // Copia los datos del buffer
            const buffer = await audioCtx.decodeAudioData(audioBuffers[url].slice(0));
            const source = audioCtx.createBufferSource();
            source.buffer = buffer;
            source.loop = loop;
            source.connect(gainNode); // Lo conecta a su perilla de volumen
            source.start(0); // Play
        }

        // Transici칩n Profesional (Crossfade)
        // Baja una canci칩n y sube la otra suavemente en 3 segundos
        function crossfadeMusic() {
            const t = audioCtx.currentTime;

            // Pista 1: Baja a 0
            gainNode1.gain.setValueAtTime(gainNode1.gain.value, t);
            gainNode1.gain.linearRampToValueAtTime(0, t + 3);

            // Pista 2: Sube a 1
            gainNode2.gain.setValueAtTime(gainNode2.gain.value, t);
            gainNode2.gain.linearRampToValueAtTime(1, t + 3);
        }

        // ==========================================
        // SECCI칍N 3: INTERFAZ TERMINAL
        // ==========================================
        const consoleDiv = document.getElementById('console-text');
        const loader = document.getElementById('terminal-loader');

        const terminalText = [
            "> System check...",
            "> Protocol: KINTSUGI initializing...",
            "> Optimizing assets...",
            "> Ready."
        ];
        let lineIdx = 0, charIdx = 0;

        // Efecto m치quina de escribir recursivo
        function typeWriter() {
            if (lineIdx < terminalText.length) {
                if (charIdx < terminalText[lineIdx].length) {
                    consoleDiv.innerHTML += terminalText[lineIdx].charAt(charIdx);
                    charIdx++;
                    setTimeout(typeWriter, 30); // Velocidad escritura
                } else {
                    consoleDiv.innerHTML += "<br>";
                    lineIdx++;
                    charIdx = 0;
                    setTimeout(typeWriter, 200); // Pausa entre l칤neas
                }
            }
        }

        // Arrancar carga inmediatamente al abrir la p치gina
        loadAssets();

        // Evento al dar click en "Ejecutar Protocolo"
        enterBtn.addEventListener('click', () => {
            initAudioSystem(); // IMPORTANTE: El audio solo puede iniciar tras un clic del usuario

            // Animaci칩n de desvanecer la pantalla negra
            loader.style.transition = "opacity 1s";
            loader.style.opacity = "0";
            setTimeout(() => loader.style.display = "none", 1000);

            // Iniciar Mariposas
            initButterflies();
        });

        // ==========================================
        // SECCI칍N 4: CANVAS MARIPOSAS (Optimizado)
        // ==========================================
        const canvas = document.getElementById('bg-canvas');
        const ctx = canvas.getContext('2d');
        let butterflies = [];

        // Ajusta el tama침o del canvas si gira el celular
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // Clase que define c칩mo es y c칩mo se mueve una mariposa
        class Butterfly {
            constructor() {
                this.init();
            }

            init() {
                // Posici칩n aleatoria
                this.x = Math.random() * canvas.width;
                this.y = canvas.height + Math.random() * 100;
                this.size = Math.random() * 20 + 10;
                this.speed = Math.random() * 1 + 0.5;
                this.angle = 0;
                this.angleSpeed = Math.random() * 0.1 - 0.05;
                this.opacity = 0;
                this.fadeIn = true;
                this.emoji = "游붊";
            }

            update() {
                // Matem치ticas para movimiento fluido (seno/coseno)
                this.y -= this.speed; // Subir
                this.x += Math.sin(this.y * 0.02) * 0.5; // Oscilar
                this.angle += this.angleSpeed; // Rotar

                // Control de opacidad (aparecer suavemente)
                if (this.fadeIn) {
                    this.opacity += 0.01;
                    if (this.opacity >= 1) this.fadeIn = false;
                } else if (this.y < -50) {
                    this.init(); // Si sale de pantalla arriba, se recicla abajo
                }

                // Dibujar en el canvas
                ctx.save();
                ctx.globalAlpha = this.opacity;
                ctx.translate(this.x, this.y);
                ctx.rotate(this.angle);
                ctx.font = `${this.size}px serif`;
                ctx.shadowColor = "#00FFFF";
                ctx.shadowBlur = 10;
                ctx.fillText(this.emoji, 0, 0);
                ctx.restore();
            }
        }

        // Crea 50 mariposas y las anima en bucle
        function initButterflies() {
            for (let i = 0; i < 50; i++) {
                butterflies.push(new Butterfly());
                butterflies[i].y = Math.random() * canvas.height;
            }
            animateButterflies();
        }

        function animateButterflies() {
            ctx.clearRect(0, 0, canvas.width, canvas.height); // Borra frame anterior
            butterflies.forEach(b => b.update()); // Mueve cada mariposa
            requestAnimationFrame(animateButterflies); // Pide siguiente frame
        }

        // ==========================================
        // SECCI칍N 5: L칍GICA DE SCROLL Y EVENTOS
        // ==========================================

        // Scroll Reveal: Hace aparecer las estrofas suavemente
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) entry.target.classList.add('visible');
            });
        }, { threshold: 0.1 });
        document.querySelectorAll('.stanza, .swiper').forEach(el => observer.observe(el));

        // Control de Scroll para Audio y Fondo
        const musicTrigger = document.getElementById('music-trigger');
        let musicSwitched = false;

        window.addEventListener('scroll', () => {
            // Calcular porcentaje de scroll para cambiar el color de fondo
            const scrollPercent = (window.scrollY / (document.body.scrollHeight - window.innerHeight)) * 100;
            const bgContainer = document.getElementById('bg-canvas');

            // Fases del color de fondo seg칰n la historia
            if (scrollPercent < 30) {
                bgContainer.style.background = "radial-gradient(circle at bottom, #1a0b2e 0%, #050510 70%)";
            } else if (scrollPercent < 60) {
                bgContainer.style.background = "radial-gradient(circle at bottom, #3b0a15 0%, #050510 70%)";
            } else {
                bgContainer.style.background = "radial-gradient(circle at bottom, #2e2a0b 0%, #050510 70%)";
            }

            // Efecto Parallax Luna
            const moon = document.getElementById('moon');
            moon.style.transform = `translateY(${window.scrollY * 0.2}px)`;

            // Cambio de M칰sica (Mamichula -> Piano)
            const triggerPos = musicTrigger.getBoundingClientRect().top;
            if (triggerPos < window.innerHeight / 1.5 && !musicSwitched && audioCtx) {
                musicSwitched = true;
                crossfadeMusic();
            }
        });

        // Visualizador de Audio (Latido de la luna)
        function visualizeAudio() {
            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            function draw() {
                requestAnimationFrame(draw);
                analyser.getByteFrequencyData(dataArray);
                let bass = 0;
                // Tomamos promedio de graves
                for (let i = 0; i < 10; i++) bass += dataArray[i];
                const bassAvg = bass / 10;

                // Aplicamos escala a la luna
                const scale = 1 + (bassAvg / 500);
                const moon = document.getElementById('moon');
                // Nota: Mantenemos el translate del scroll aqu칤 tambi칠n
                moon.style.transform = `scale(${scale}) translateY(${window.scrollY * 0.2}px)`;
                moon.style.boxShadow = `0 0 ${bassAvg}px rgba(255, 255, 224, 0.3)`;
            }
            draw();
        }

        // ==========================================
        // SECCI칍N 6: CONFIGURACI칍N SWIPER (CARRUSEL)
        // ==========================================
        const swiper = new Swiper(".mySwiper", {
            effect: "cards",
            grabCursor: true,
            loop: true,
            cardsEffect: { perSlideOffset: 8, perSlideRotate: 2, slideShadows: true },
            pagination: { el: ".swiper-pagination", dynamicBullets: true },
            on: {
                // Auto-play de videos solo en la slide activa
                slideChangeTransitionEnd: function () {
                    document.querySelectorAll('.slide-video').forEach(v => { v.pause(); v.currentTime = 0; });
                    const activeSlide = this.slides[this.activeIndex];
                    const vid = activeSlide.querySelector('video');
                    if (vid) vid.play();
                }
            }
        });

        // Destellos m치gicos al tocar la pantalla
        document.addEventListener('click', e => createSparkle(e.pageX, e.pageY));
        document.addEventListener('touchstart', e => createSparkle(e.touches[0].pageX, e.touches[0].pageY));

        function createSparkle(x, y) {
            const s = document.createElement('div');
            s.classList.add('sparkle');
            s.style.left = x + 'px'; s.style.top = y + 'px';
            document.body.appendChild(s);
            setTimeout(() => s.remove(), 1000);
        }

        // ==========================================
        // SECCI칍N 7: CANDADO BIOM칄TRICO (Mantener presionado)
        // ==========================================
        const lockBtn = document.getElementById('fingerprint-btn');
        const fillBar = document.getElementById('fill-bar');
        const vowBox = document.getElementById('final-vow-box');
        const lockScreen = document.getElementById('lock-screen');
        let holdTimer, progress = 0;

        // Inicia el llenado
        const startHold = (e) => {
            if (e.type === 'touchstart') e.preventDefault(); // Evita men칰 contextual en m칩vil
            if (navigator.vibrate) navigator.vibrate(50); // Vibraci칩n h치ptica
            holdTimer = setInterval(() => {
                progress += 2;
                fillBar.style.height = progress + '%';
                if (progress >= 100) unlock(); // Si llega a 100, desbloquea
            }, 30);
        };

        // Cancela si suelta antes
        const endHold = () => {
            clearInterval(holdTimer);
            if (progress < 100) { progress = 0; fillBar.style.height = '0%'; }
        };

        // 칄xito: Desbloqueo
        function unlock() {
            clearInterval(holdTimer);
            if (navigator.vibrate) navigator.vibrate([200, 100, 200]);

            // Animaci칩n de explosi칩n
            lockScreen.style.transition = "opacity 1s, transform 1s";
            lockScreen.style.opacity = "0";
            lockScreen.style.transform = "scale(1.5)";
            setTimeout(() => lockScreen.style.display = 'none', 1000);

            // Muestra el texto final
            vowBox.classList.remove('locked');
            vowBox.classList.add('unlocked');

            // CLIMAX DE AUDIO: Sube el volumen al m치ximo
            if (gainNode2) {
                const t = audioCtx.currentTime;
                gainNode2.gain.linearRampToValueAtTime(1.0, t + 1);
            }
        }

        // Listeners para Mouse y Touch
        lockBtn.addEventListener('mousedown', startHold);
        lockBtn.addEventListener('mouseup', endHold);
        lockBtn.addEventListener('mouseleave', endHold);
        lockBtn.addEventListener('touchstart', startHold);
        lockBtn.addEventListener('touchend', endHold);

    </script>
</body>

</html>