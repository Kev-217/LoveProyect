<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M√°s que un Clic...</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />

    <style>
        /* =========================================
           1. VARIABLES Y CONFIGURACI√ìN MAESTRA
           ========================================= */
        :root {
            /* Colores del tema */
            --bg-color: #050510;
            --text-gold: #FFD700;
            --accent-blue: #00FFFF;
            --accent-purple: #9D00FF;

            /* --- TIPOGRAF√çA FLUIDA (La magia de la v3.0) --- */
            /* clamp(m√≠nimo, ideal, m√°ximo) 
               Esto hace que el texto cambie suavemente de tama√±o seg√∫n la pantalla */
            --font-size-base: clamp(1rem, 2vw, 1.25rem);
            --font-size-title: clamp(1.5rem, 5vw, 2.5rem);
            --spacing-stanza: clamp(20px, 5vh, 40px);
            /* Espacio entre estrofas */
        }

        body {
            margin: 0;
            background-color: var(--bg-color);
            color: #fff;
            font-family: 'Georgia', serif;
            /* Fuente elegante */
            overflow-x: hidden;
            /* Evita scroll horizontal accidental */
            font-size: var(--font-size-base);
        }

        /* =========================================
           2. PANTALLA DE CARGA (Tipo Hacker/Terminal)
           ========================================= */
        #terminal-loader {
            position: fixed;
            /* Fijo encima de todo */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 9999;
            /* La capa m√°s alta */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-family: 'Courier New', monospace;
            /* Letra de c√≥digo */
            color: #0f0;
            /* Verde matrix */
            padding: 20px;
        }

        /* Contenedor del texto que se escribe solo */
        .typing-effect {
            font-size: clamp(1rem, 3vw, 1.5rem);
            margin-bottom: 20px;
            text-align: left;
            width: 100%;
            max-width: 500px;
            min-height: 100px;
            /* Reserva espacio para que no "brinque" al escribir */
        }

        /* Bot√≥n de inicio */
        #enter-btn {
            padding: 15px 30px;
            background: transparent;
            border: 2px solid var(--accent-blue);
            color: var(--accent-blue);
            font-family: 'Courier New', monospace;
            font-size: 1rem;
            cursor: pointer;
            opacity: 0;
            /* Invisible al inicio */
            pointer-events: none;
            /* No se puede clicar hasta que cargue */
            transition: all 0.5s;
            box-shadow: 0 0 10px var(--accent-blue);
        }

        /* Clase para activar el bot√≥n cuando todo est√° listo */
        #enter-btn.active {
            opacity: 1;
            pointer-events: all;
        }

        #enter-btn:hover {
            background: var(--accent-blue);
            color: #000;
        }

        /* =========================================
           3. CANVAS DE FONDO (Mariposas)
           ========================================= */
        #bg-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            /* Detr√°s del texto */
            /* El gradiente base del fondo */
            background: radial-gradient(circle at bottom, #1a0b2e 0%, #050510 70%);
            transition: background 3s ease;
            /* Cambio de color suave al hacer scroll */
            filter: hue-rotate(220deg) brightness(150%) contrast(120%) drop-shadow(0 0 5px #00FFFF);
        }

        /* =========================================
           4. ESTILOS DEL POEMA (Glassmorphism)
           ========================================= */
        .poem-container {
            max-width: 700px;
            margin: 0 auto;
            /* Centrado horizontal */
            padding: 100px 20px;
            text-align: center;
            position: relative;
            z-index: 10;
        }

        .stanza {
            margin-bottom: 60px;
            padding: var(--spacing-stanza);
            border-radius: 20px;
            /* Efecto cristal esmerilado */
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            /* Para Safari/iPhone */
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);

            /* Estado inicial para animaci√≥n (invisible y m√°s abajo) */
            opacity: 0;
            transform: translateY(50px) scale(0.9);
            transition: all 0.8s cubic-bezier(0.25, 1, 0.5, 1);
            will-change: transform, opacity;
        }

        /* Optimizaci√≥n m√≥vil: Reducir calidad del cristal en pantallas peque√±as */
        @media (max-width: 768px) {
            .stanza {
                backdrop-filter: none; /* Desactivar blur pesado en m√≥vil */
                background: rgba(20, 20, 30, 0.85); /* Fondo un poco m√°s s√≥lido para compensar */
                box-shadow: 0 4px 10px rgba(0,0,0,0.3); /* Sombra m√°s simple */
            }
        }

        /* Cuando JS detecta que es visible, le a√±ade esta clase */
        .stanza.visible {
            opacity: 1;
            transform: translateY(0) scale(1);
            background: rgba(255, 255, 255, 0.07);
            border-color: rgba(255, 215, 0, 0.3);
        }

        .gold-text {
            color: var(--text-gold);
            font-weight: bold;
        }

        .blue-text {
            color: var(--accent-blue);
            text-shadow: 0 0 5px var(--accent-blue);
        }

        /* =========================================
           5. CARRUSEL (SWIPER)
           ========================================= */
        .swiper {
            width: 90%;
            max-width: 500px;
            aspect-ratio: 3 / 4;
            /* Proporci√≥n vertical */
            margin: 80px auto;
            border-radius: 20px;
            box-shadow: 0 0 30px rgba(157, 0, 255, 0.4);
            opacity: 0;
            transition: opacity 2s;
        }

        .swiper.visible {
            opacity: 1;
        }

        .swiper-slide img,
        .swiper-slide video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 15px;
            background-color: #000;
        }

        /* =========================================
           6. VOTOS FINALES Y CANDADO
           ========================================= */
        .final-vow {
            font-size: clamp(1.2rem, 3vw, 1.5rem);
            color: var(--text-gold);
            border: 1px solid var(--text-gold);
            padding: 40px;
            margin-top: 100px;
            background: rgba(0, 0, 0, 0.5);
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.2);
            border-radius: 10px;
            font-style: italic;
        }

        /* Luna de fondo */
        .moon-bg {
            position: fixed;
            top: 10%;
            right: -10%;
            /* Tama√±o responsivo de la luna */
            width: clamp(200px, 40vw, 400px);
            height: clamp(200px, 40vw, 400px);
            background: radial-gradient(circle, #ffffe0 10%, rgba(255, 255, 224, 0) 70%);
            border-radius: 50%;
            opacity: 0.15;
            z-index: -1;
            filter: blur(20px);
            pointer-events: none;
        }

        /* --- ESTILOS DEL C√ìDIGO SECRETO --- */
        #passcode-input {
            background: transparent;
            border: none;
            border-bottom: 2px solid #0f0; /* L√≠nea verde hacker */
            color: #0f0;
            font-family: 'Courier New', monospace;
            font-size: 2rem;
            width: 100px;
            text-align: center;
            letter-spacing: 10px;
            outline: none;
        }

        #passcode-input::placeholder {
            color: rgba(0, 255, 0, 0.3);
        }

        /* Animaci√≥n de error (temblor) */
        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            50% { transform: translateX(10px); }
            75% { transform: translateX(-10px); }
            100% { transform: translateX(0); }
        }

        .shake-animation {
            animation: shake 0.3s ease-in-out;
            border-bottom: 2px solid red !important;
            color: red !important;
        }

        /* Caja del Candado */
        #lock-screen {
            text-align: center;
            padding: 50px;
            border: 1px solid var(--accent-blue);
            background: rgba(0, 0, 0, 0.8);
            border-radius: 20px;
            margin-top: 50px;
            position: relative;
            overflow: hidden;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }

        /* Bot√≥n de Huella/Coraz√≥n */
        #fingerprint-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 2px solid var(--text-gold);
            background: transparent;
            color: var(--text-gold);
            font-size: 2rem;
            cursor: pointer;
            position: relative;
            z-index: 2;
            animation: pulse-btn 2s infinite;
            /* Latido */
        }

        @keyframes pulse-btn {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.4);
            }

            70% {
                box-shadow: 0 0 0 20px rgba(255, 215, 0, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(255, 215, 0, 0);
            }
        }

        /* Relleno amarillo al mantener presionado */
        .fill-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 0%;
            /* JS cambiar√° esto */
            background: linear-gradient(to top, #FFD700, #ffaa00);
            z-index: 0;
            opacity: 0.3;
        }

        /* Estados de borrosidad del texto final */
        .final-vow.locked {
            filter: blur(20px);
            pointer-events: none;
            user-select: none;
            transition: filter 2s ease;
        }

        .final-vow.unlocked {
            filter: blur(0px);
        }

        /* Part√≠culas (brillitos al tocar) */
        .sparkle {
            position: absolute;
            width: 6px;
            height: 6px;
            background: var(--text-gold);
            border-radius: 50%;
            pointer-events: none;
            box-shadow: 0 0 10px var(--text-gold);
            animation: sparkle-anim 1s linear forwards;
            z-index: 999;
        }

        @keyframes sparkle-anim {
            100% {
                transform: scale(3);
                opacity: 0;
            }
        }

        /* RESPONSIVIDAD */
        /* PC: */
        @media (min-width: 768px) {
            .poem-container {
                max-width: 800px;
            }

            .stanza {
                font-size: 1.5rem;
                padding: 60px;
            }

            .swiper {
                width: 500px;
            }
        }

        /* M√≥vil: */
        .stanza {
            /* Mantener el texto balanceado para que no se corten los versos */
            text-wrap: balance;
            word-wrap: break-word;
        }
    </style>
</head>

<body>

    <div id="terminal-loader">
        <div class="typing-effect" id="console-text"></div>
        
        <div id="access-panel" style="display: none; text-align: center; margin-top: 20px;">
            <p style="color: #0f0; font-family: 'Courier New'; margin-bottom: 10px;">INGRESE C√ìDIGO DE ACCESO:</p>
            
            <input type="text" id="passcode-input" maxlength="3" autocomplete="off" placeholder="_ _ _">
            
            <br><br>
            <button id="enter-btn">[ DESENCRIPTAR ]</button>
            
            <p id="error-msg" style="color: red; font-family: 'Courier New'; display: none; margin-top: 10px;">
                ‚ö†Ô∏è ACCESO DENEGADO
            </p>
        </div>
    </div>

    <canvas id="bg-canvas"></canvas>

    <svg class="kintsugi-crack" viewBox="0 0 100 100" preserveAspectRatio="none">
        <defs>
            <linearGradient id="gold-gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" style="stop-color:#bf953f;stop-opacity:0" />
                <stop offset="50%" style="stop-color:#fcf6ba;stop-opacity:1" />
                <stop offset="100%" style="stop-color:#b38728;stop-opacity:0" />
            </linearGradient>
        </defs>

        <path d="M50,-10 Q45,20 55,30 T45,60 T55,90 T50,110" fill="none" stroke="url(#gold-gradient)"
            stroke-width="1.5" />

        <path d="M20,-10 Q10,30 30,50 T15,110" fill="none" stroke="url(#gold-gradient)" stroke-width="0.4"
            style="animation-delay: 4.5s;" />

        <path d="M80,-10 Q90,40 70,60 T85,110" fill="none" stroke="url(#gold-gradient)" stroke-width="0.4"
            style="animation-delay: 7.5s;" />

        <path d="M-10,30 Q40,50 60,40 T110,60" fill="none" stroke="url(#gold-gradient)" stroke-width="0.2"
            style="animation-delay: 9.5s;" />
    </svg>

    <style>
        .kintsugi-crack {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            /* Detr√°s de todo */
            opacity: 0.6;
            /* Transparencia sutil */
            pointer-events: none;
            /* Dejar pasar el clic */
            filter: drop-shadow(0 0 5px gold);
            /* Resplandor */
        }

        .kintsugi-crack path {
            stroke-dasharray: 200;
            /* Longitud del trazo */
            stroke-dashoffset: 200;
            /* Escondido inicialmente */
            animation: drawCrack 10s ease-out forwards;
            /* Animaci√≥n de dibujo */
            animation-delay: 3.5s;
            /* Espera inicial general */
        }

        @keyframes drawCrack {
            to {
                stroke-dashoffset: 0;
            }
        }
    </style>

    <div class="moon-bg" id="moon"></div>

    <div class="poem-container">
        <div class="stanza">Yo fui el viajero ciego que solt√≥ tu mano,<br>
            buscando falsos fuegos en mapas extranjeros;<br>
            cre√≠ que el para√≠so era un <span class="gold-text">lugar lejano</span>,<br>
            y perd√≠ la ruta por mirar senderos.
        </div>
        <div class="stanza">Camin√© persiguiendo un oasis inventado,<br>
            una espiga dorada que fue solo reflejo;<br>
            idealizando sombras, sin haberlas tocado,<br>
            mientras t√∫ te romp√≠as a solas frente al espejo.
        </div>
        <div class="stanza">Te dej√© all√≠ dormida, mi peque√±a <span class="gold-text">albondiguita</span>,<br>
            huyendo de un vac√≠o que no supe llenar.<br>
            Busqu√© en la falsa magia lo que el ego necesita,<br>
            sin ver que era tu calma mi forma de respirar.
        </div>
        <div class="stanza">Pero el <span class="gold-text">karma</span>, maestro de lecciones tan crudas,<br>
            me oblig√≥ a ver de lejos tu nueva libertad;<br>
            te vi brillar entre tantos, ajena a mis dudas,<br>
            con la fuerza imponente de tu propia verdad.
        </div>
        <div class="stanza">Mis celos fueron lava, mi mente una herida,<br>
            imaginando manos rozando lo que am√©;<br>
            escotes que luc√≠as, segura y decidida,<br>
            mientras yo en mi silencio, borracho te llor√©.
        </div>
        <div class="stanza">En mis noches de fr√≠o buscaba a mi <span class="gold-text">sirena</span>,<br>
            ese dulce tarareo que al sue√±o me llevaba;<br>
            quer√≠a ser tu borreguito, purgar mi condena,<br>
            volver a ese refugio que tu piel me guardaba.
        </div>
        <div class="stanza">Pero el hambre nos gan√≥, rompimos la distancia,<br>
            la carne fue el b√°lsamo para el desconsuelo;<br>
            tu cuerpo hab√≠a cambiado, perd√≠ la arrogancia,<br>
            tus curvas dibujaban un nuevo desvelo.
        </div>
        <div class="stanza">Volvimos a la cama sin t√≠tulos ni jueces,<br>
            viviendo en esa casa nuestra propia anarqu√≠a;<br>
            haci√©ndolo con rabia, dos o tres mil veces,<br>
            llenando con gemidos la estancia vac√≠a.
        </div>
        <div class="stanza">Ah√≠ encontr√© mi paz, en el <span class="gold-text">fruto sagrado</span>,<br>
            ese dulce remedio para mi ansiedad;<br>
            el sabor que cur√≥ mi esp√≠ritu cansado,<br>
            sentirme en casa, a salvo, en plena oscuridad.
        </div>
        <div class="stanza">Jugamos al caos, <span class="gold-text">huevos revueltos</span>,<br>
            gritos de placer fueron mi absoluci√≥n;<br>
            con mis dedos sedientos, r√°pidos y sueltos,<br>
            te di lo que callabas en cada rinc√≥n.
        </div>
        <div class="stanza">En menos de un mes descubrimos, piel contra piel,<br>
            lo que un a√±o de novios no supo ense√±ar;<br>
            que el sexo trasciende al instinto m√°s fiel,<br>
            y es un lenguaje nuevo para <span class="gold-text">reaprender a amar</span>.
        </div>
        <div class="stanza">Y ah√≠ cambi√≥ el sistema, se reescribi√≥ solo,<br>
            ya no eras la ni√±a que hu√≠a a dormir;<br>
            te vi mujer inmensa, rompiendo el protocolo,<br>
            ense√±√°ndome a quedarme, a luchar y a sentir.
        </div>
        <div class="stanza">Volvimos rotos, con las manos abiertas,<br>
            t√∫ con tu pelo nuevo, yo con mi vieja culpa;<br>
            cruzamos el umbral de las puertas inciertas,<br>
            pidiendo al universo una segunda disculpa.
        </div>
        <div class="stanza">No fue borr√≥n, ni un falso dilema,<br>
            fue aceptar la historia, mirarnos las <span class="gold-text">heridas</span>;<br>
            callaste mi error para salvar mi emblema,<br>
            y ante tus padres fuiste escudo de mi vida.
        </div>
        <div class="stanza">Esa noche en <span class="gold-text">Wings</span>, con una rosa improvisada,<br>
            envuelta en aluminio, imperfecta y real;<br>
            te ped√≠ que volvieras, mi ni√±a, mi amada,<br>
            a escribir con mi pluma un nuevo final.
        </div>

        <div class="stanza" id="music-trigger">
            Hoy s√© que no eres musa, eres algo m√°s grande,<br>
            eres los cuatro elementos de mi propia estaci√≥n;<br>
            eres <span class="blue-text">Fuego</span> que calienta cuando el fr√≠o se expande,<br>
            la pasi√≥n que en tus brazos me da relajaci√≥n.
        </div>
        <div class="stanza">Eres <span class="blue-text">Agua</span> que limpia con llanto cristalino,<br>
            record√°ndome lo fr√°giles que somos al amar;<br>
            eres <span class="blue-text">Viento</span> que empuja mi barco en el camino,<br>
            cuando el estr√©s del mundo me quiere sofocar.
        </div>
        <div class="stanza">Pero sobre todo eres <span class="blue-text">Tierra</span>, mi suelo firme,<br>
            donde plantamos frutos de esfuerzo y de valor;<br>
            donde saco dieces sin llegar a destruirme,<br>
            porque tu paz me ayuda a ser un triunfador.
        </div>
        <div class="stanza">S√≠, el "clic" fue un destello, una manzana dulce,<br>
            un veneno que un d√≠a me atrev√≠ a probar;<br>
            pero t√∫ eres la vida que hace que me impulse,<br>
            la <span class="gold-text">compa√±era eterna</span> con quien quiero luchar.
        </div>
        <div class="stanza">Quiz√°s no somos perfectos, ni cuento de hadas,<br>
            quiz√°s a veces falte la chispa o la fluidez;<br>
            pero hay coraje en nuestras manos entrelazadas,<br>
            y ganas de quedarnos hasta la vejez.
        </div>
        <div class="stanza">Entend√≠ a la mala, tras tanto desatino,<br>
            que amar no es colonizar, es ceder y crecer;<br>
            que t√∫ eres mi certeza, mi hogar, mi destino,<br>
            y que la entrega, mi vida... siempre vence al placer.
        </div>
        <div class="stanza">No quiero m√°s musas viviendo en mi mente,<br>
            te quiero a ti, Dana, con tu luz y tu gris;<br>
            aqu√≠ estoy en mi barco, contigo al frente,<br>
            siendo, por fin, <span class="gold-text">imperfectamente feliz</span>.
        </div>

        <div class="swiper mySwiper" id="gallery-trigger">
            <div class="swiper-wrapper">
                <div class="swiper-slide"><img src="1.jpeg" loading="lazy"></div>
                <div class="swiper-slide"><video src="2v.mp4" muted loop playsinline class="slide-video" preload="none"></video></div>
                <div class="swiper-slide"><img src="4.jpeg" loading="lazy"></div>
                <div class="swiper-slide"><img src="5.jpeg" loading="lazy"></div>
                <div class="swiper-slide"><img src="6.jpeg" loading="lazy"></div>
                <div class="swiper-slide"><img src="8.jpeg" loading="lazy"></div>
                <div class="swiper-slide"><img src="10.jpeg" loading="lazy"></div>
                <div class="swiper-slide"><video src="11v.mp4" muted loop playsinline class="slide-video" preload="none"></video></div>
                <div class="swiper-slide"><video src="13v.mp4" muted loop playsinline class="slide-video" preload="none"></video></div>
                <div class="swiper-slide"><img src="15.jpeg" loading="lazy"></div>
                <div class="swiper-slide"><video src="16v.mp4" muted loop playsinline class="slide-video" preload="none"></video></div>
                <div class="swiper-slide"><video src="17v.mp4" muted loop playsinline class="slide-video" preload="none"></video></div>
            </div>
            <div class="swiper-pagination"></div>
        </div>

        <div id="lock-screen">
            <div class="fill-overlay" id="fill-bar"></div>
            <p style="font-family: 'Courier New'; color: var(--accent-blue); margin-bottom: 20px;">
                ‚ö†Ô∏è ARCHIVO ENCRIPTADO <br>
                <span style="font-size: 1.2rem"><br>¬øDesea SANAR el v√≠nculo?<br></span>
            </p>
            <button id="fingerprint-btn">‚ù§Ô∏è‚Äçü©π</button>
        </div>

        <div class="stanza final-vow locked" id="final-vow-box">
            Con esta mano, reparo la historia,<br>
            te entrego todo mi coraz√≥n;<br>
            tu paz ser√° mi mayor victoria,<br><br>
            y con este anillo...<br>
            <span
                style="display: block; font-size: clamp(2rem, 5vw, 3rem); text-shadow: 0 0 20px gold; margin-top: 20px;">TE
                PROMETO MI MEJOR VERSI√ìN</span>
        </div>

        <br>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

    <script>
        // ==========================================
        // SECCI√ìN 1: PRELOADER REAL (Gesti√≥n de Recursos)
        // ==========================================
        const assetsToLoad = [
            'mamichula.mp3',
            'piano.mp3',
            '1.jpeg',
            '2v.mp4',
            '4.jpeg',
            '5.jpeg',
            '6.jpeg',
            '8.jpeg',
            '10.jpeg',
            '11v.mp4',
            '13v.mp4',
            '15.jpeg',
            '16v.mp4',
            '17v.mp4'
        ];

        // Variable para el scroll
        let currentScrollY = 0;

        // Variables donde guardaremos la m√∫sica cargada en memoria
        let audioBuffers = {};
        // Variables del sistema de audio profesional (Web Audio API)
        let audioCtx, gainNode1, gainNode2, source1, source2, analyser;

        const enterBtn = document.getElementById('enter-btn');

        // Funci√≥n as√≠ncrona: Carga los archivos uno por uno
        async function loadAssets() {
            // Iniciamos el texto de "hacker" visual mientras carga lo real
            typeWriter();

            // Creamos una lista de tareas de descarga (Promesas)
            const promises = assetsToLoad.map(async (url) => {
                try {
                    // Pide el archivo al servidor
                    const response = await fetch(url);
                    // Lo convierte en datos puros (ArrayBuffer)
                    const arrayBuffer = await response.arrayBuffer();
                    audioBuffers[url] = arrayBuffer; // Lo guarda en memoria

                } catch (e) {
                    console.error("Error cargando recurso:", url);
                }
            });

            // Espera a que TODO se descargue antes de continuar
            await Promise.all(promises);
        }

        // ==========================================
        // SECCI√ìN 2: SISTEMA DE AUDIO (Web Audio API)
        // ==========================================
        // Esto reemplaza a las etiquetas <audio> b√°sicas para evitar cortes.

        function initAudioSystem() {
            // Crea el "Contexto de Audio" (el motor de sonido del navegador)
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();

            // Crea "Nodos de Ganancia" (como las perillas de volumen de una mesa de DJ)
            gainNode1 = audioCtx.createGain();
            gainNode2 = audioCtx.createGain();
            analyser = audioCtx.createAnalyser(); // Para analizar graves (efecto luna)

            // Configurar vol√∫menes iniciales
            gainNode1.gain.value = 1; // Pista 1 (Mamichula) al 100%
            gainNode2.gain.value = 0; // Pista 2 (Piano) silenciada

            // Decodifica y reproduce Audio 1
            playBuffer(assetsToLoad[0], gainNode1, true); // true = loop infinito
            // Prepara Audio 2 pero empieza en silencio
            playBuffer(assetsToLoad[1], gainNode2, true);

            // Conexiones: Fuente -> Volumen -> Analizador -> Bocinas
            gainNode1.connect(analyser);
            gainNode2.connect(analyser);
            analyser.connect(audioCtx.destination);

            visualizeAudio(); // Inicia la animaci√≥n de la luna
        }

        // Funci√≥n auxiliar para decodificar y tocar un audio desde memoria
        async function playBuffer(url, gainNode, loop) {
            // Copia los datos del buffer
            const buffer = await audioCtx.decodeAudioData(audioBuffers[url].slice(0));
            const source = audioCtx.createBufferSource();
            source.buffer = buffer;
            source.loop = loop;
            source.connect(gainNode); // Lo conecta a su perilla de volumen
            source.start(0); // Play
        }

        // Transici√≥n Profesional (Crossfade)
        // Baja una canci√≥n y sube la otra suavemente en 2 segundos
        function crossfadeMusic() {
            const t = audioCtx.currentTime;

            // Pista 1: Baja a 0
            gainNode1.gain.setValueAtTime(gainNode1.gain.value, t);
            gainNode1.gain.linearRampToValueAtTime(0, t + 2);

            // Pista 2: Sube a 1
            gainNode2.gain.setValueAtTime(gainNode2.gain.value, t);
            gainNode2.gain.linearRampToValueAtTime(1, t + 2);
        }

        // ==========================================
        // SECCI√ìN 3: INTERFAZ TERMINAL
        // ==========================================
        const consoleDiv = document.getElementById('console-text');
        const loader = document.getElementById('terminal-loader');

        const terminalText = [
            "> System check...",
            "> Critical Error: Heartbroken.",
            "> Rewriting core memories...",
            "> Mission: Clarify the truth",
            "> Protocol: KINTSUGI initialized...",
        ];
        let lineIdx = 0, charIdx = 0;

        // Efecto m√°quina de escribir recursivo
        function typeWriter() {
            if (lineIdx < terminalText.length) {
                if (charIdx < terminalText[lineIdx].length) {
                    consoleDiv.innerHTML += terminalText[lineIdx].charAt(charIdx);
                    charIdx++;
                    setTimeout(typeWriter, 20); // Velocidad escritura
                } else {
                    consoleDiv.innerHTML += "<br>";
                    lineIdx++;
                    charIdx = 0;
                    setTimeout(typeWriter, 100); // Pausa entre l√≠neas
                }
            } else {
                const panel = document.getElementById('access-panel');
                if(panel) {
                    panel.style.display = 'block';
                    document.getElementById('passcode-input').focus();
                }
            }
        }

        // Arrancar carga inmediatamente al abrir la p√°gina
        loadAssets();

        // ==========================================
        // L√ìGICA DE VALIDACI√ìN (C√ìDIGO 544) - VERSI√ìN MEJORADA
        // ==========================================
        const passInput = document.getElementById('passcode-input');
        const errorMsg = document.getElementById('error-msg');
        
        function startExperience() {
            initAudioSystem(); // Inicia el audio
            
            // Quita la pantalla negra
            loader.style.transition = "opacity 1s";
            loader.style.opacity = "0";
            setTimeout(() => loader.style.display = "none", 1000);
            
            // Inicia mariposas (Con protecci√≥n por si fallan)
            if(typeof initButterflies === 'function') initButterflies();
        }

        // Listeners
        enterBtn.addEventListener('click', validateCode);

        if(passInput) {
            passInput.addEventListener('keypress', function (e) {
                if (e.key === 'Enter') validateCode();
            });
        }

        function validateCode() {
            if (passInput.value === "544") {
                // --- CORRECTO ---
                if(errorMsg) errorMsg.style.display = 'none';
                passInput.style.borderBottom = "2px solid #00FFFF"; 
                
                // Mensaje bonito (del c√≥digo B)
                consoleDiv.innerHTML += "<br>> <span style='color:#00FFFF'>ACCESS GRANTED. WELCOME HOME.</span>";
                
                setTimeout(startExperience, 1000); 

            } else {
                // --- INCORRECTO ---
                if (navigator.vibrate) navigator.vibrate(200);
                if(errorMsg) errorMsg.style.display = 'block';
                
                passInput.classList.add('shake-animation');
                setTimeout(() => {
                    passInput.classList.remove('shake-animation');
                    passInput.value = "";
                }, 500);
            }
        }

        // ==========================================
        // MEJORA 2: MARIPOSAS EN CANVAS
        // ==========================================
        const canvas = document.getElementById('bg-canvas');
        const ctx = canvas.getContext('2d');
        let butterflies = [];

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        class Butterfly {
            constructor() {
                this.init();
            }

            init() {
                this.x = Math.random() * canvas.width;
                this.y = canvas.height + Math.random() * 100;

                // Tama√±o
                this.size = Math.random() * 25 + 15;

                this.speed = Math.random() * 1.5 + 0.5;
                this.angle = 0;
                this.angleSpeed = Math.random() * 0.05 - 0.025;
                this.opacity = 0;
                this.fadeIn = true;

                // VARIABLES PARA EL ALETEO
                this.flapPhase = Math.random() * Math.PI; // Cada una aletea a su ritmo
                this.flapSpeed = 0.2 + Math.random() * 0.1; // Velocidad del aleteo

                this.emoji = "ü¶ã";
            }

            update() {
                // 1. Movimiento hacia arriba y oscilaci√≥n lateral
                this.y -= this.speed;
                this.x += Math.sin(this.y * 0.02) * 1.5; // Oscilaci√≥n m√°s suave
                this.angle += this.angleSpeed;

                // 2. C√°lculo del Aleteo (Simulaci√≥n de 3D)
                this.flapPhase += this.flapSpeed;
                // El valor va de 0.2 (cerrada) a 1.0 (abierta)
                const wingScale = Math.abs(Math.sin(this.flapPhase)) * 0.8 + 0.2;

                // 3. Opacidad (Fade in/out)
                if (this.fadeIn) {
                    this.opacity += 0.01;
                    if (this.opacity >= 1) this.fadeIn = false;
                } else if (this.y < -50) {
                    this.init(); // Reiniciar si sale de pantalla
                }

                // 4. DIBUJADO
                ctx.save();

                ctx.globalAlpha = this.opacity;
                ctx.translate(this.x, this.y);
                ctx.rotate(this.angle);

                // AQUI OCURRE LA MAGIA DEL ALETEO:
                // Escalamos solo el eje X (ancho) basado en el c√°lculo wingScale
                ctx.scale(wingScale, 1);

                ctx.font = `${this.size}px serif`;

                // Sombra (Glow) Azul Cyan
                ctx.shadowColor = "#00FFFF";

                // Ajuste de posici√≥n para centrar al escalar
                ctx.fillText(this.emoji, -this.size / 2, this.size / 2);

                ctx.restore();
            }
        }

        function initButterflies() {
            // Limpiamos el array por si acaso
            butterflies = [];
            // Crear 30 mariposas
            for (let i = 0; i < 30; i++) {
                butterflies.push(new Butterfly());
                // Esparcirlas inicialmente en Y
                butterflies[i].y = Math.random() * canvas.height;
            }
            animateButterflies();
        }

        function animateButterflies() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            butterflies.forEach(b => b.update());
            requestAnimationFrame(animateButterflies);
        }

        // ==========================================
        // SECCI√ìN 5: L√ìGICA DE SCROLL Y EVENTOS
        // ==========================================

        // Scroll Reveal: Hace aparecer las estrofas suavemente
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) entry.target.classList.add('visible');
            });
        }, { threshold: 0.1 });
        document.querySelectorAll('.stanza, .swiper').forEach(el => observer.observe(el));

        // Control de Scroll para Audio y Fondo
        const musicTrigger = document.getElementById('music-trigger');
        let musicSwitched = false;

        window.addEventListener('scroll', () => {
            currentScrollY = window.scrollY; // Solo guardamos el valor
            
            // L√≥gica ligera para el cambio de m√∫sica (esto est√° bien aqu√≠)
            if (!musicSwitched && musicTrigger) {
                const triggerPos = musicTrigger.getBoundingClientRect().top;
                if (triggerPos < window.innerHeight / 1.5 && audioCtx) {
                    musicSwitched = true;
                    crossfadeMusic();
                }
            }
        }, { passive: true }); // 'passive: true' mejora el rendimiento del scroll en m√≥viles

        // Visualizador de Audio (Latido de la luna)
        function visualizeAudio() {
            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            const bgContainer = document.getElementById('bg-canvas');
            const moon = document.getElementById('moon'); // Referencia fuera del loop

            function draw() {
                requestAnimationFrame(draw);
                analyser.getByteFrequencyData(dataArray);
                
                // 1. C√°lculo de Audio
                let bass = 0;
                for (let i = 0; i < 10; i++) bass += dataArray[i];
                const bassAvg = bass / 10;
                const scale = 1 + (bassAvg / 500);

                // 2. APLICAR TRANSFORMACI√ìN UNIFICADA (Scroll + Audio)
                // Usamos la variable global 'currentScrollY'
                moon.style.transform = `translate3d(0, ${currentScrollY * 0.2}px, 0) scale(${scale})`;
                moon.style.boxShadow = `0 0 ${bassAvg}px rgba(255, 255, 224, 0.3)`;

                // 3. CAMBIO DE COLOR DE FONDO (Optimizado)
                // Calculamos esto aqu√≠ para que sea fluido
                const docHeight = document.body.scrollHeight - window.innerHeight;
                const scrollPercent = (currentScrollY / (docHeight || 1)) * 100;

                // Solo cambiamos si es necesario (evita repintados innecesarios)
                if (scrollPercent < 30) {
                    bgContainer.style.backgroundImage = "radial-gradient(circle at bottom, #1a0b2e 0%, #050510 70%)";
                } else if (scrollPercent < 60) {
                    bgContainer.style.backgroundImage = "radial-gradient(circle at bottom, #3b0a15 0%, #050510 70%)";
                } else {
                    bgContainer.style.backgroundImage = "radial-gradient(circle at bottom, #2e2a0b 0%, #050510 70%)";
                }
            }
            draw();
        }

        // ==========================================
        // SECCI√ìN 6: CONFIGURACI√ìN SWIPER (CARRUSEL)
        // ==========================================
        const swiper = new Swiper(".mySwiper", {
            effect: "cards",
            grabCursor: true,
            loop: true,
            cardsEffect: { perSlideOffset: 8, perSlideRotate: 2, slideShadows: true },
            pagination: { el: ".swiper-pagination", dynamicBullets: true },
            on: {
                // Auto-play de videos solo en la slide activa
                slideChangeTransitionEnd: function () {
                    document.querySelectorAll('.slide-video').forEach(v => { v.pause(); v.currentTime = 0; });
                    const activeSlide = this.slides[this.activeIndex];
                    const vid = activeSlide.querySelector('video');
                    if (vid) vid.play();
                }
            }
        });

        // Destellos m√°gicos al tocar la pantalla
        document.addEventListener('click', e => createSparkle(e.pageX, e.pageY));
        document.addEventListener('touchstart', e => createSparkle(e.touches[0].pageX, e.touches[0].pageY));

        function createSparkle(x, y) {
            const s = document.createElement('div');
            s.classList.add('sparkle');
            s.style.left = x + 'px'; s.style.top = y + 'px';
            document.body.appendChild(s);
            setTimeout(() => s.remove(), 1000);
        }

        // ==========================================
        // SECCI√ìN 7: CANDADO BIOM√âTRICO (Mantener presionado)
        // ==========================================
        const lockBtn = document.getElementById('fingerprint-btn');
        const fillBar = document.getElementById('fill-bar');
        const vowBox = document.getElementById('final-vow-box');
        const lockScreen = document.getElementById('lock-screen');
        let holdTimer, progress = 0;

        // Inicia el llenado
        const startHold = (e) => {
            if (e.type === 'touchstart') e.preventDefault(); // Evita men√∫ contextual en m√≥vil
            if (navigator.vibrate) navigator.vibrate(50); // Vibraci√≥n h√°ptica
            holdTimer = setInterval(() => {
                progress += 2;
                fillBar.style.height = progress + '%';
                if (progress >= 100) unlock(); // Si llega a 100, desbloquea
            }, 30);
        };

        // Cancela si suelta antes
        const endHold = () => {
            clearInterval(holdTimer);
            if (progress < 100) { progress = 0; fillBar.style.height = '0%'; }
        };

        // √âxito: Desbloqueo
        function unlock() {
            clearInterval(holdTimer);
            if (navigator.vibrate) navigator.vibrate([200, 100, 200]);

            // Animaci√≥n de explosi√≥n
            lockScreen.style.transition = "opacity 1s, transform 1s";
            lockScreen.style.opacity = "0";
            lockScreen.style.transform = "scale(1.5)";
            setTimeout(() => lockScreen.style.display = 'none', 1000);

            // Muestra el texto final
            vowBox.classList.remove('locked');
            vowBox.classList.add('unlocked');

            // CLIMAX DE AUDIO: Sube el volumen al m√°ximo
            if (gainNode2) {
                const t = audioCtx.currentTime;
                gainNode2.gain.linearRampToValueAtTime(1.0, t + 1);
            }
        }

        // Listeners para Mouse y Touch
        lockBtn.addEventListener('mousedown', startHold);
        lockBtn.addEventListener('mouseup', endHold);
        lockBtn.addEventListener('mouseleave', endHold);
        lockBtn.addEventListener('touchstart', startHold);
        lockBtn.addEventListener('touchend', endHold);

    </script>
</body>

</html>